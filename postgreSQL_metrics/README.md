# Анализ маркетинговых и пользовательских данных
Данный набор SQL-запросов предназначен для комплексного анализа маркетинговых и пользовательских данных, включая сегментацию пользователей и оценку эффективности рекламных кампаний.
# Оглавление
1. [Описание таблиц](#описание-таблиц)
2. [Основные задачи](#основные-задачи)    
    2.1. [Агрегация маркетинговых показателей по пользователям](#агрегация-маркетинговых-показателей-по-пользователям)    
    2.2. [Расчет ключевых конверсий по когортам (по дате регистрации пользователей)](#расчет-ключевых-конверсий-по-когортам-по-дате-регистрации-пользователей)     
    2.3. [Анализ времени на сайте и поведенческих метрик](#анализ-времени-на-сайте-и-поведенческих-метрик)     
    2.4. [Анализ активности пользователей](#анализ-активности-пользователей)     
    2.5. [Сегментация пользователей](#сегментация-пользователей)     
    2.6. [Когортный анализ и удержание](#когортный-анализ-и-удержание)     
    2.7. [Управленческие сводки](#управленческие-сводки)   
3. [Выводы](#выводы)

## Описание таблиц
Для анализа используются следующие таблицы

### users
Таблица с информацией о всех пользователях.    

`id` - уникальный идентификатор пользователя    
`username` - логин на платформе    
`first_name` - имя    
`last_name` - фамилия    
`is_active` - активирован ли аккаунт    
`date_joined` - дата и время регистрации    
`email` - почта    
`referal_user` - пользователь, который его пригласил (реферал)    
`company_id` - идентификатор компании (FK - Company)    
`tier` - ранг на платформе    
`score` - количество очков опыта на платформе    

### userentry
В этой таблице фиксируются заходы пользователя на платформу - когда, в какое время и на какую страницу пользователь зашел первый раз за сутки.    

`id` - уникальный идентификатор     
`entry_at` - дата и время входа на платформу    
`page_id` - идентификатор страницы входа (FK - Page)    
`user_id` - идентификатор пользователя (FK - Users)    


### marketing_metrics
Таблица хранит детальные данные о маркетинговых активностях, привязанные к конкретным пользователям. Она позволяет отслеживать и анализировать эффективность маркетинговых кампаний и поведение пользователей на основе различных метрик.

`id` - уникальный идентификатор маркетинговой метрики    
`user_id` - идентификатор пользователя (FK - Users)    
`impressions` - количество показов    
`clicks` - количество кликов    
`leads` - количество заявок    
`valid_leads` - количество квалифицированных заявок    
`purchases` - сумма покупки    
`spent` - потраченный бюджет    
`revenue` - выручка    
`time_on_site_sec` - время проведенное на сайте в секундах    
`pages_per_session` - количество страниц за сессию    
`bounce_rate_percent` - процент отказов    

## Основные задачи
### Агрегация маркетинговых показателей по пользователям
Осуществляется подсчет суммарных показателей для каждого пользователя, а именно:
*    показы объявлений (impressions), 
*    клики (clicks), 
*    лиды (leads), 
*    покупи (purchases), 
*    затраты (spent),
*    выручка (revenue)     

```sql
SELECT 
    user_id,
    SUM(impressions) AS total_impressions, --количество показов
    SUM(clicks) AS total_clicks, --количество кликов
    SUM(leads) AS total_leads, --количество заявок
    SUM(purchases) AS total_purchases, --сумма покупки
    SUM(spent) AS total_spent, --потраченный бюджет
    SUM(revenue) AS total_revenue --общая выручка
FROM marketing_metrics mm join users u on mm.user_id = u.id
WHERE 1=1
AND u.id >= 94 --исключаем тестовых пользователей
and u.is_active = 1 --рассматриваем только активных пользователей
GROUP BY user_id
order by user_id;
```
Расчет данных показателей позволяет анализировать вклад каждого пользователя в общие бизнес-результаты.

### Расчет ключевых конверсий по когортам (по дате регистрации пользователей)
Производится расчет основных показателей эффективности маркетинга: CTR (клики к показам), CR1 (конверсия кликов в лиды), CR2 (конверсия квалифицированных лидов в покупки) и других. Это помогает оценивать качество лидов и доходность по когортам пользователей.    
```sql
with sum_metrics as (
	SELECT 
	    to_char(u.date_joined, 'YYYY-MM') as cohort,
	    SUM(impressions) AS total_impressions, --количество показов
	    SUM(clicks) AS total_clicks, --количество кликов
	    SUM(leads) AS total_leads, --количество заявок
	    SUM(valid_leads) as total_valid_leads, --количество квалифицированных заявок
	    SUM(purchases) AS total_purchases, --сумма покупки
	    SUM(spent) AS total_spent, --потраченный бюджет
	    SUM(revenue) AS total_revenue --общая выручка
	FROM marketing_metrics mm join users u on mm.user_id = u.id
	WHERE 1=1
	AND u.id >= 94 --исключаем тестовых пользователей
	and u.is_active = 1 --рассматриваем только активных пользователей
	GROUP BY cohort
	order by cohort
)
SELECT 
	cohort,
--CTR (%) (click through rate) - показывает коэффициент кликабельности, т.е. как показ ковертируется в клик.
	ROUND((total_clicks::numeric / total_impressions) * 100,2) as "CTR (%)",
--CR1 (%) - конверсия из клика в целевое действие
	ROUND((total_leads::numeric / total_clicks) * 100,2) as "CR1 (%)",
--purchases_per_click_percent - конверсия из клика в покупку
	ROUND((total_purchases::numeric / total_clicks) * 100,2) as "purchases_per_click_percent (%)",
--vCR (%) - конверсия из лида в квалифицированного лида
	ROUND((total_valid_leads::numeric / total_leads) * 100,2) as "vCR (%)",
--purchases_per_lead_percent - конверсия из лида в покупку
	ROUND((total_purchases::numeric / total_leads) * 100,2) as "purchases_per_lead_percent (%)",	
--vleads_per_click_percent - конверсия из клика в квалифицированного лида
	ROUND((total_valid_leads::numeric / total_clicks) * 100,2) as "vleads_per_click_percent (%)",	
--CR2 (%) - конверсия из квалифицированного лида в покупку
	ROUND((total_purchases::numeric / total_valid_leads) * 100,2) as "CR2 (%)"
FROM sum_metrics;
```
Итоговая таблица   

|cohort|"CTR (%)"|"CR1 (%)"|"purchases_per_click_percent (%)"|"vCR (%)"|"purchases_per_lead_percent (%)"|"vleads_per_click_percent (%)"|"CR2 (%)"|    
|-----------|---------|-------|------|-------|--------|------|------|    
2021-11|4.99|21.76|5.19|51.32|23.86|11.17|46.50|
2021-12|4.93|19.54|4.77|54.90|24.40|10.73|44.44|
2022-01|4.78|19.24|4.48|53.43|23.31|10.28|43.63|
2022-02|5.13|19.98|4.74|52.20|23.74|10.43|45.48|
2022-03|5.14|19.04|4.61|52.58|24.21|10.01|46.05|
2022-04|4.78|22.52|4.81|51.05|21.35|11.50|41.82|  

#### Выводы по метрикам
1. __CTR (%)__ (кликабельность) стабильно держится около 4.78–5.14%, без значительных колебаний, что свидетельствует о стабильном интересе аудитории к объявлениям.
2. __CR1 (%)__ (конверсия с клика в лид) варьируется от 19.04% до 22.52%. Самая высокая конверсия в лиды у когорты 2022-04 (22.52%), что указывает на улучшение качества лидов.
3. __Purchases_per_click (%)__ находится в диапазоне 4.48%–5.19%, максимальное значение в 2021-11, снижение видно в последующих периодах, возможно, требуется оптимизация этапа покупки.
4. __vCR (%)__ (вероятно, конверсия в покупку на уровне визитов) колеблется около 51–55%, что показывает относительно стабильное количество покупок от общего трафика.
5. __Purchases_per_lead (%)__ — доля покупок от лидов находится в районе 21.35%–24.40%, что говорит о том, что примерно четверть лидов становится покупателями.
6. __Vleads_per_click (%)__ около 10–11.5%, с пиком у 2022-04 (11.50%), указывает на количество релевантных лидов с кликов.
7. __CR2 (%)__ (конверсия с квалифицированных лидов в покупку) колеблется в диапазоне 41.82%–46.50%, с максимальным значением у когорты 2021-11. Это означает, что из числа лидов, которые прошли предварительную оценку и признаны потенциально готовыми к покупке, около 42–47% действительно совершают покупку. Это достаточно высокий показатель, указывающий на хорошее качество лидов и эффективность работы отдела продаж.

Метрики демонстрируют стабильное качество маркетинговых активностей и эффективную работу с лидами и конверсиями на разных этапах. Незначительные колебания показателей могут свидетельствовать о сезонных изменениях или корректировках в стратегиях.

### Анализ времени на сайте и поведенческих метрик
Среднее время пребывания на сайте, среднее количество просмотренных страниц и показатель отказов (bounce rate) агрегируются по когортам, что отражает вовлеченность и пользовательский опыт.
```sql
SELECT 
	to_char(u.date_joined, 'YYYY-MM') as cohort,
	to_char(
	    interval '1 second' * ROUND(AVG(time_on_site_sec)),
	    'HH24:MI:SS'
	) as avg_time_on_site, --формат в читабельный вид "часы:минуты:секунды"
	ROUND(AVG(pages_per_session),2) as avg_page_session,
	ROUND(AVG(bounce_rate_percent), 2) as avg_bounce_rate --средневзвешенный процент отказов
FROM marketing_metrics mm join users u on mm.user_id = u.id
WHERE 1=1
AND u.id >= 94 --исключаем тестовых пользователей
and u.is_active = 1 --рассматриваем только активных пользователей
GROUP BY cohort
order by cohort;
```
#### Выводы по времени на сайте и поведенческим метрикам по когортам   
1. __Среднее время пребывания на сайте__ стабильно около часа, что свидетельствует о высокой вовлеченности пользователей, так как посетители проводят значительное время на платформе.
2. __Среднее количество просмотренных страниц за сессию__ держится в диапазоне 7.75–8.29, что также подтверждает активное изучение контента и интерес к предложению.
3. __Показатель отказов__ (bounce rate) колеблется в диапазоне 48.98–52.99%, что является умеренно высоким уровнем. Это может указывать на то, что около половины посетителей покидают сайт после просмотра одной страницы, что требует внимания к навигации и первому впечатлению.

В целом, когорты демонстрируют стабильные поведенческие метрики с небольшими колебаниями, что говорит о постоянном пользовательском опыте.

### Анализ активности пользователей
Подсчитываются количество входов (сессий) за период, уникальные пользователи и среднее количество сессий на пользователя. Это показывает, как часто и регулярно пользователи взаимодействуют с продуктом.
```sql
SELECT 
	to_char(u.date_joined, 'YYYY-MM') as cohort,
-- Количество входов (сессий) - показывает, насколько часто пользователи возвращаются на сайт или в приложение.
	COUNT(*) AS total_sessions,  -- общее число сессий
	COUNT(DISTINCT user_id) AS unique_users,  -- уникальные пользователи
-- Среднее количество сессий на пользователя - показывает, насколько регулярно каждый пользователь взаимодействует с продуктом.
	ROUND(COUNT(*)::numeric / NULLIF(COUNT(DISTINCT user_id), 0), 2) AS avg_sessions_per_user
FROM userentry ue join users u on ue.user_id = u.id
WHERE 1=1
AND u.id >= 94 --исключаем тестовых пользователей
and u.is_active = 1 --рассматриваем только активных пользователей
GROUP BY cohort
order by cohort;
```
#### Выводы по активности пользователей (сессии и среднее количество сессий на пользователя по когортам)
1. __Количество сессий__ значительно варьируется между когортами: 776 для ноября 2021, но всего 191 для февраля 2022. Это означает, что пользователи разных когорт демонстрируют разную активность на сайте или в приложении.
2. __Среднее количество сессий на пользователя__ заметно снижается с 4.88 в ноябре 2021 до 1.24 в феврале 2022. Это может указывать на снижение частоты возврата пользователей более поздних когорт.

Уменьшение активности связано с временным фактором, что характерно для когортного анализа, показывающего, как поведение пользователей меняется с течением времени после регистрации.

### Сегментация пользователей
Пользователи разбиваются на группы по активности на основе количества кликов.
Данный запрос показывает, сколько пользователей разного уровня активности (низкая, средняя, высокая) пришли в каждый период времени

```sql
WITH user_clicks AS (
  SELECT 
    user_id,
    SUM(clicks) AS total_clicks
  FROM marketing_metrics
  GROUP BY user_id
),
clicks_quartiles AS (
  SELECT
    user_id,
    total_clicks,
    ntile(4) OVER (ORDER BY total_clicks) AS click_quartile
  FROM user_clicks
),
activites_users as (
	SELECT
	  user_id,
	  total_clicks,
	  click_quartile,
	  CASE
	    WHEN total_clicks <= 290 THEN 'низкая активность'
	    WHEN total_clicks <=535 THEN 'средняя активность'
	    ELSE 'высокая активность'
	  END AS activity_segment
	FROM clicks_quartiles
	ORDER BY total_clicks)
select 
	to_char(u.date_joined, 'YYYY-MM') as cohort,
	activity_segment,
	case 
		when activity_segment = 'низкая активность' then count(u.id)
		when activity_segment = 'средняя активность' then count(u.id)
		when activity_segment = 'высокая активность' then count(u.id)
	end as cnt_users_in_segments
from users u join activites_users au on u.id = au.user_id
WHERE 1=1
AND u.id >= 94 --исключаем тестовых пользователей
and u.is_active = 1 --рассматриваем только активных пользователей
GROUP BY cohort, activity_segment
order by cohort;
```
#### Выводы по сегментации пользователей по активности (по количеству кликов)
Пользователи аккумулируются в три сегмента активности: низкая (до 290 кликов), средняя (до 535 кликов) и высокая активность (более 535 кликов), что позволяет четко разделить аудиторию по уровню вовлеченности.

1. В каждой когорте количество пользователей __с высокой активностью__ составляет значительную часть: например, 72 в ноябре 2021, 258 в январе 2022 и 465 в феврале 2022, что говорит о росте количества активных пользователей в эти периоды.
2. Число пользователей __с низкой и средней активностью__ также меняется, но доля высокой активности растет для более поздних когорт, что может свидетельствовать о прогрессивном повышении вовлеченности новых пользователей.    

Такая сегментация помогает маркетингу и продуктовой команде таргетировать предложения и коммуникации, направленные на удержание пользователей с разной степенью активности: 
*   с активными — развивать лояльность, 
*   с менее активными — мотивировать к более частому взаимодействию.

Такая сегментация позволяет помогает принимать решения по маркетинговым стратегиям и продуктовым улучшениям на основе этих сегментов.

### Когортный анализ и удержание
Данный запрос позволяет анализировать, сколько пользователей из каждой когорты (сформированной по месяцу регистрации) оставались активными по месяцам после первой активности
```sql
WITH cohorts AS (
    SELECT 
        id AS user_id, 
        DATE_TRUNC('month', date_joined) AS cohort_month,
        COUNT(u.id) OVER(partition by DATE_TRUNC('month', date_joined)) AS cohort_size
    FROM users u
	WHERE 1=1
	AND u.id >= 94 --исключаем тестовых пользователей
	and u.is_active = 1 --рассматриваем только активных пользователей
),
activity AS (
    SELECT 
        user_id, 
        DATE_TRUNC('month', entry_at) AS activity_month
    FROM userentry
),
retention AS (
    SELECT 
        c.cohort_month,
        a.activity_month,
        COUNT(DISTINCT a.user_id) AS active_users,
        c.cohort_size
    FROM cohorts c
    LEFT JOIN activity a ON c.user_id = a.user_id 
       AND a.activity_month >= c.cohort_month
    GROUP BY c.cohort_month, a.activity_month, c.cohort_size
)
SELECT 
    r.cohort_month,
    r.activity_month,
    r.active_users,
    r.cohort_size,
    ROUND((r.active_users::decimal / r.cohort_size) * 100, 2) AS retention_percent
FROM retention r
ORDER BY r.cohort_month, r.activity_month;
```
#### Выводы по когортному анализу

1. Большинство когорт показывают высокое удержание в первый месяц после регистрации — около 80-90% пользователей активны в месяц регистрации.

2. Дальше заметно резкое снижение удержания: через 1 месяц процент активных пользователей падает примерно в 2-3 раза (примерно 30-40%).

3. На 2-3 месяц после регистрации активность снижается еще сильнее, до менее 10%, а для некоторых когорт до нуля.

Размер когорт существенно разнится, что влияет на статистику — в январе 2022 было много новых пользователей (514), но удержание сильно упало к следующему месяцу.   
Такая динамика типична для digital-продуктов, где высокий отток в первые месяцы — обычное явление. Метрика retention_percent показывает, что необходимо обратить внимание на первые 1-2 месяца после регистрации для удержания пользователей и повышения их активности.

### Управленческие сводки
#### Общее количество активных и неактивных пользователей
```sql
SELECT 
	case 
		when is_active = 1 then 'Активные пользователи'
	else 
		'Неактивные пользователи'
	end as activities,
	COUNT(id) AS user_count,
	ROUND(COUNT(id) * 100.0 / (SELECT COUNT(*) FROM users WHERE id >= 94), 2) AS percent
FROM users
WHERE 1=1
AND id >= 94 --исключаем тестовых пользователей
GROUP BY activities;
```
__Итоговая таблица__
|activities|user_count|percent|
|----------|-----------|------|
|Активные пользователи|2400|89.02|
|Неактивные пользователи|296|10.98|

Результат показывает количество активных и неактивных пользователей, за исключением тестовых, а также процент активных и неактивных пользователей от общего числа.

#### Количество новых пользователей по месяцам
```sql
SELECT 
    DATE_TRUNC('month', date_joined) AS month,
    COUNT(*) AS cnt_new_users
FROM users
WHERE 1=1
AND id >= 94 --исключаем тестовых пользователей
GROUP BY month
ORDER BY month;
```
__Итоговая таблица__
|month|cnt_new_users|
|-----|--------------|
2021-11-01 00:00:00.000|188|
2021-12-01 00:00:00.000|132|
2022-01-01 00:00:00.000|602|
2022-02-01 00:00:00.000|1058|
2022-03-01 00:00:00.000|479|
2022-04-01 00:00:00.000|237|    

Данный результат демонстрирует количество новых зарегистрировавшихся пользователей в месяц, исключая тестовых пользоваталей.
#### ROI и средний чек
```sql
SELECT
    CASE WHEN SUM(purchases) = 0 THEN 0 ELSE ROUND(SUM(revenue) / SUM(purchases), 2) END AS "AOV",
    CASE WHEN SUM(spent) = 0 THEN 0 ELSE ROUND(SUM(revenue) / SUM(spent), 2) END AS "ROI"
FROM marketing_metrics;
```
#### Выводы по расчету ROI и AOV
1. Средний чек (AOV) равен 401.50, что означает средний доход с одной покупки. 
2. ROI (возврат на инвестиции) равен 1.99, то есть на каждый потраченный рубль в маркетинг компания получает примерно 1.99 рубля выручки.

Это говорит о том, что затраты на маркетинг практически окупаются вдвое, что является хорошим результатом для бизнеса.    
Средний чек в 401.50 показывает, какая в среднем сумма тратится одним покупателем за одну покупку, что важно для оценки доходности.

# Выводы
Данная система аналитики позволяет получить следующие выводы:

1. __Эффективность маркетинговых каналов__: Какие каналы привлечения пользователей наиболее эффективны с точки зрения конверсий и ROI.
2. __Качество лидов__: Какие когорты пользователей приносят наиболее качественные лиды и покупки.
3. __Пользовательский опыт__: Какие области сайта или продукта нуждаются в улучшениях для повышения вовлеченности.
4. __Тенденции роста пользовательской базы__: Насколько активно привлекаются новые пользователи и как часто они возвращаются.
5. __Эффективность стратегий удержания__: Как долго пользователи продолжают использовать продукт или сервис после регистрации.
6. __Потенциал для оптимизации маркетинговых кампаний__: Какие сегменты пользователей наиболее перспективны для таргетинга.
